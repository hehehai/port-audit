name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Verify tag version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if [ "v$VERSION" != "${GITHUB_REF_NAME}" ]; then
            echo "Tag ${GITHUB_REF_NAME} does not match package.json version $VERSION"
            exit 1
          fi
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2

  build-binaries:
    needs: release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: macos
            build_script: build:bin
            bin_name: port
          - os: ubuntu-latest
            target: linux
            build_script: build:bin
            bin_name: port
          - os: windows-latest
            target: windows
            build_script: build:bin:win
            bin_name: port.exe
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install
        run: bun install --frozen-lockfile
      - name: Build binary
        run: bun run ${{ matrix.build_script }}
      - name: Package binary
        id: package
        shell: bash
        run: |
          if [ "${{ matrix.os }}" != "windows-latest" ]; then
            chmod +x "dist/${{ matrix.bin_name }}"
          fi
          TARBALL="port-audit-${GITHUB_REF_NAME}-${{ matrix.target }}.tar.gz"
          tar -czf "$TARBALL" -C dist "${{ matrix.bin_name }}"
          SHA256=$(node -e "const fs=require('fs');const crypto=require('crypto');const data=fs.readFileSync('${TARBALL}');console.log(crypto.createHash('sha256').update(data).digest('hex'));")
          echo "$SHA256  $TARBALL" > "$TARBALL.sha256"
          echo "tarball=$TARBALL" >> "$GITHUB_OUTPUT"
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
          echo "sha_file=$TARBALL.sha256" >> "$GITHUB_OUTPUT"
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.package.outputs.tarball }}
            ${{ steps.package.outputs.sha_file }}

  publish-npm:
    needs: release
    runs-on: macos-latest
    environment: public
    permissions:
      contents: read
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Debug npm config
        run: |
          if [ -n "$NPM_TOKEN" ]; then
            echo "NPM_TOKEN is set"
          else
            echo "NPM_TOKEN is missing"
          fi
      - name: Setup Bun
        if: ${{ env.NPM_TOKEN != '' }}
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install
        if: ${{ env.NPM_TOKEN != '' }}
        run: bun install --frozen-lockfile
      - name: Build binary
        if: ${{ env.NPM_TOKEN != '' }}
        run: |
          bun run build:bin
          chmod +x dist/port
      - name: Publish to npm
        if: ${{ env.NPM_TOKEN != '' }}
        env:
          NODE_AUTH_TOKEN: ${{ env.NPM_TOKEN }}
        run: |
          npm config set //registry.npmjs.org/:_authToken="$NODE_AUTH_TOKEN"
          npm publish --access public

  publish-npm-bridge:
    needs: release
    runs-on: ubuntu-latest
    environment: public
    permissions:
      contents: read
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Debug npm config
        run: |
          if [ -n "$NPM_TOKEN" ]; then
            echo "NPM_TOKEN is set"
          else
            echo "NPM_TOKEN is missing"
          fi
      - name: Sync portaudit version
        if: ${{ env.NPM_TOKEN != '' }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          node -e "const fs=require('fs');const path='packages/portaudit/package.json';const pkg=JSON.parse(fs.readFileSync(path,'utf8'));pkg.version='${VERSION}';pkg.dependencies['@hehehai/port-audit']='${VERSION}';fs.writeFileSync(path, JSON.stringify(pkg, null, 2)+'\\n');"
      - name: Publish portaudit
        if: ${{ env.NPM_TOKEN != '' }}
        working-directory: packages/portaudit
        env:
          NODE_AUTH_TOKEN: ${{ env.NPM_TOKEN }}
        run: |
          npm config set //registry.npmjs.org/:_authToken="$NODE_AUTH_TOKEN"
          npm publish --access public

  publish-brew:
    needs: release
    runs-on: macos-latest
    environment: public
    permissions:
      contents: read
    env:
      HOMEBREW_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}
      HOMEBREW_TAP: ${{ secrets.HOMEBREW_TAP }}
      HOMEBREW_FORMULA: ${{ secrets.HOMEBREW_FORMULA }}
    steps:
      - name: Setup Homebrew
        if: ${{ env.HOMEBREW_TOKEN != '' }}
        uses: Homebrew/actions/setup-homebrew@master
      - name: Debug brew config
        run: |
          if [ -n "$HOMEBREW_TOKEN" ]; then
            echo "HOMEBREW_TOKEN is set"
          else
            echo "HOMEBREW_TOKEN is missing"
          fi
          if [ -n "$HOMEBREW_TAP" ]; then
            echo "HOMEBREW_TAP=$HOMEBREW_TAP"
          else
            echo "HOMEBREW_TAP is missing"
          fi
          if [ -n "$HOMEBREW_FORMULA" ]; then
            echo "HOMEBREW_FORMULA=$HOMEBREW_FORMULA"
          else
            echo "HOMEBREW_FORMULA is missing"
          fi
      - name: Prepare formula update
        if: ${{ env.HOMEBREW_TOKEN != '' }}
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ env.HOMEBREW_TOKEN }}
          GH_TOKEN: ${{ env.HOMEBREW_TOKEN }}
        run: |
          URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/port-audit-${{ github.ref_name }}-macos.tar.gz"
          curl -L "$URL" -o source.tar.gz
          SHA256=$(shasum -a 256 source.tar.gz | awk '{print $1}')
          brew tap "$HOMEBREW_TAP"
          OUTPUT=$(brew bump-formula-pr --no-audit --no-browse \
            --url "$URL" \
            --sha256 "$SHA256" \
            "$HOMEBREW_FORMULA")
          echo "$OUTPUT"
          PR_URL=$(echo "$OUTPUT" | grep -Eo "https://github.com/[^ ]+" | tail -n 1)
          if [ -n "$PR_URL" ]; then
            gh pr merge --auto --squash "$PR_URL"
          else
            echo "No PR URL detected; skipping auto-merge."
          fi

  publish-github:
    needs: release
    runs-on: macos-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install
        run: bun install --frozen-lockfile
      - name: Build binary
        run: |
          bun run build:bin
          chmod +x dist/port
      - name: Publish to GitHub Packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm config set //npm.pkg.github.com/:_authToken="$NODE_AUTH_TOKEN"
          npm publish --registry https://npm.pkg.github.com
